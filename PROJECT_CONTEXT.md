# Dance Card Generator - Project Context

A Just Dance-style web app that generates choreography cards for any YouTube song.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                       Frontend                               │
├─────────────────────────────────────────────────────────────┤
│  index.html    - Main app with library, player, completion  │
│  admin.html    - Admin interface for song management        │
│  styles.css    - All styling for the main app               │
│  app.js        - Main application logic                     │
│  moves.js      - Move catalog for frontend                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Backend                                │
├─────────────────────────────────────────────────────────────┤
│  server.py     - Flask server with API routes               │
│  db.py         - SQLite database operations                 │
│  moves.py      - Move catalog for backend                   │
│  dancecard.db  - SQLite database file                       │
│  .lyrics_cache/- Cached audio files                         │
└─────────────────────────────────────────────────────────────┘
```

## Data Flow

### Song Processing
1. Admin enters YouTube URL + API key
2. Server fetches video info (title, artist, thumbnail)
3. Audio downloaded via yt-dlp → cached in `.lyrics_cache/`
4. BPM detected using librosa
5. Lyrics transcribed using Whisper (or manual lyrics aligned)
6. Song structure analyzed (verse, chorus, bridge, etc.)
7. Choreography generated by Claude API
8. Saved to SQLite database

### Playback
1. User selects song from library
2. Frontend fetches song data + routine via API
3. YouTube IFrame API loads video
4. Moves sync to video playback time
5. Lyrics display synced to timestamps
6. Beat counter synced to BPM

## Database Schema

### songs
| Column | Type | Description |
|--------|------|-------------|
| video_id | TEXT PK | YouTube video ID |
| title | TEXT | Song title |
| artist | TEXT | Artist name |
| youtube_url | TEXT | Full URL |
| lyrics_json | TEXT | JSON with segments |
| genre | TEXT | Optional genre |
| duration | INTEGER | Seconds |
| bpm | REAL | Beats per minute |
| thumbnail_url | TEXT | YouTube thumbnail |
| difficulty | INTEGER | 1=Easy, 2=Medium, 3=Hard |
| published | INTEGER | 0=Draft, 1=Published |
| created_at | TEXT | ISO timestamp |

### routines
| Column | Type | Description |
|--------|------|-------------|
| routine_id | INTEGER PK | Auto-increment |
| video_id | TEXT FK | References songs |
| move_sequence_json | TEXT | JSON array of moves |
| song_structure_json | TEXT | JSON with sections |
| created_at | TEXT | ISO timestamp |

### moves
| Column | Type | Description |
|--------|------|-------------|
| move_id | TEXT PK | e.g., 'step_touch' |
| name | TEXT | Display name |
| difficulty | INTEGER | 1-3 |
| body_part | TEXT | Legs/Arms/Full Body/Hips |
| description | TEXT | How to do it |
| pictogram_svg | TEXT | SVG icon |

### song_requests
| Column | Type | Description |
|--------|------|-------------|
| request_id | INTEGER PK | Auto-increment |
| youtube_url | TEXT | Requested URL |
| user_note | TEXT | Optional note |
| status | TEXT | pending/approved/rejected |
| created_at | TEXT | ISO timestamp |

## API Endpoints

### Public
- `GET /api/songs` - List published songs
- `GET /api/songs/<video_id>` - Get song with routine
- `POST /api/requests` - Submit song request

### Admin (requires X-Admin-Password header)
- `GET /api/admin/songs` - List all songs
- `POST /api/admin/process` - Process new song
- `POST /api/admin/song/<id>/publish` - Publish song
- `POST /api/admin/song/<id>/unpublish` - Unpublish song
- `DELETE /api/admin/song/<id>` - Delete song
- `GET /api/admin/requests` - List requests
- `PATCH /api/admin/request/<id>` - Update request status

## Move Catalog

### Easy (Difficulty 1)
step_touch, hip_sway, clap, slide, snap, point, stomp, groove, sway, twist

### Medium (Difficulty 2)
body_roll, arm_wave, turn, jump, shoulder_pop, punch, shimmy

## Environment Variables

```bash
ADMIN_PASSWORD=dance123  # Admin panel password
WHISPER_MODEL=small      # Whisper model size
```

## Running the App

```bash
# Install dependencies
pip install flask flask-cors openai-whisper yt-dlp librosa

# Run server
python server.py

# Access
# - Main app: http://localhost:5000
# - Admin: http://localhost:5000/admin
```

## Key Features

1. **Manual Lyrics Input** - Paste official lyrics for accuracy
2. **Instrumental Detection** - No moves during non-vocal sections
3. **Repeated Choreography** - Same chorus = same moves
4. **Song Structure Detection** - INTRO, VERSE 1/2/3, PRE-CHORUS, CHORUS, BRIDGE, OUTRO
5. **BPM Detection** - Beat counter synced to actual tempo
6. **Audio Caching** - Re-processing reuses cached audio
7. **Direct Song Links** - `/?id=VIDEO_ID` for sharing
