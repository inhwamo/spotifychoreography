<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timestamp Editor - Dance Card Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF2D78;
            --secondary: #00D4FF;
            --accent: #FFE135;
            --green: #00F5A0;
            --dark: #1a1a2e;
            --darker: #0f0f1a;
            --darkest: #080810;
            --light: #ffffff;
            --verse-color: rgba(102, 126, 234, 0.7);
            --chorus-color: rgba(245, 87, 108, 0.7);
            --selected-color: rgba(0, 245, 160, 0.8);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--darkest);
            height: 100vh;
            color: var(--light);
            overflow: hidden;
        }

        /* Main Grid Layout */
        .editor-container {
            display: grid;
            grid-template-rows: auto 60fr 40fr;
            height: 100vh;
        }

        /* Header */
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: var(--darker);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .song-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .song-info img {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
        }

        .song-info h1 {
            font-size: 1rem;
            background: linear-gradient(135deg, #FF2D78, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .song-info .artist {
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF2D78, #FF6B35);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-success {
            background: var(--green);
            color: var(--dark);
        }

        .btn:hover { transform: scale(1.02); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; }

        .status-indicator {
            padding: 4px 10px;
            background: rgba(0,245,160,0.2);
            border: 1px solid var(--green);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--green);
        }

        .btn-undo {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-undo:disabled {
            opacity: 0.3;
        }

        /* Top Section: Table + Video */
        .top-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: rgba(255,255,255,0.1);
            overflow: hidden;
        }

        /* Left Panel: Lyrics Table + Edit */
        .lyrics-panel {
            display: flex;
            flex-direction: column;
            background: var(--darker);
            overflow: hidden;
        }

        .panel-header {
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header span {
            color: rgba(255,255,255,0.5);
            font-weight: normal;
        }

        /* Lyrics Table */
        .lyrics-table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .lyrics-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .lyrics-table th {
            position: sticky;
            top: 0;
            background: var(--dark);
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .lyrics-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
        }

        .lyrics-table tr {
            cursor: pointer;
            transition: background 0.15s;
        }

        .lyrics-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .lyrics-table tr.selected {
            background: rgba(0,245,160,0.15);
        }

        .lyrics-table tr.selected td {
            border-color: rgba(0,245,160,0.3);
        }

        .lyrics-table .col-num {
            width: 40px;
            color: rgba(255,255,255,0.4);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .lyrics-table .col-time {
            width: 70px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--secondary);
            font-size: 0.8rem;
        }

        .lyrics-table .col-dur {
            width: 50px;
            font-family: 'JetBrains Mono', monospace;
            color: rgba(255,255,255,0.4);
            font-size: 0.75rem;
        }

        .lyrics-table .col-text {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Edit Panel */
        .edit-panel {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .edit-panel-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-bottom: 10px;
        }

        .edit-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .edit-row label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
            min-width: 50px;
        }

        .edit-row input, .edit-row textarea {
            flex: 1;
            padding: 8px 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .edit-row input:focus, .edit-row textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .edit-row input.time-input {
            width: 80px;
            flex: none;
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
        }

        .edit-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Right Panel: Video */
        .video-panel {
            display: flex;
            flex-direction: column;
            background: var(--darker);
        }

        .video-wrapper {
            flex: 1;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .video-wrapper iframe {
            width: 100%;
            height: 100%;
        }

        .video-controls {
            padding: 12px 15px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .video-time-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .current-time-large {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary);
        }

        .duration-small {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: rgba(255,255,255,0.4);
        }

        .playback-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .play-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .play-btn:hover {
            transform: scale(1.1);
        }

        .seek-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .seek-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Bottom Section: Waveform */
        .waveform-section {
            background: var(--darkest);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .waveform-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: var(--darker);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .waveform-toolbar-left, .waveform-toolbar-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .zoom-btn {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: white;
            cursor: pointer;
            font-size: 1rem;
        }

        .zoom-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .zoom-label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Waveform Container */
        .waveform-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            position: relative;
            background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.1) 100%);
        }

        .waveform-content {
            height: 100%;
            position: relative;
            min-width: 100%;
        }

        /* Time Ruler */
        .time-ruler {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 25px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .ruler-mark {
            position: absolute;
            top: 5px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: rgba(255,255,255,0.4);
            transform: translateX(-50%);
        }

        .ruler-mark::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 15px;
            width: 1px;
            height: 8px;
            background: rgba(255,255,255,0.2);
        }

        /* Waveform Bars */
        .waveform-bars {
            position: absolute;
            top: 30px;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
        }

        .waveform-bar {
            background: linear-gradient(180deg, var(--secondary) 0%, rgba(0,212,255,0.5) 100%);
            border-radius: 1px 1px 0 0;
            min-width: 1px;
        }

        /* Subtitle Blocks */
        .subtitle-tracks {
            position: absolute;
            top: 95px;
            left: 0;
            right: 0;
            bottom: 10px;
        }

        .subtitle-block {
            position: absolute;
            height: 35px;
            background: var(--verse-color);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .subtitle-block:hover {
            border-color: rgba(255,255,255,0.5);
        }

        .subtitle-block.selected {
            background: var(--selected-color);
            border-color: var(--green);
            z-index: 5;
        }

        .subtitle-block.chorus {
            background: var(--chorus-color);
        }

        .subtitle-block .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
            background: rgba(255,255,255,0.2);
            opacity: 0;
            transition: opacity 0.15s;
        }

        .subtitle-block:hover .resize-handle,
        .subtitle-block.selected .resize-handle {
            opacity: 1;
        }

        .resize-handle.left { left: 0; border-radius: 4px 0 0 4px; }
        .resize-handle.right { right: 0; border-radius: 0 4px 4px 0; }

        /* Playhead */
        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff0000;
            z-index: 20;
            pointer-events: none;
        }

        .playhead::before {
            content: '';
            position: absolute;
            top: 0;
            left: -6px;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 10px solid #ff0000;
        }

        /* Bottom Toolbar */
        .waveform-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px 15px;
            background: var(--darker);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Keyboard Hints */
        .keyboard-hint {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.6);
            max-width: 250px;
        }

        .keyboard-hint kbd {
            display: inline-block;
            padding: 2px 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            margin-right: 3px;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div style="text-align:center">
            <div class="spinner"></div>
            <p style="margin-top:15px">Loading editor...</p>
        </div>
    </div>

    <div class="editor-container">
        <!-- Header -->
        <div class="editor-header">
            <div class="song-info">
                <img id="song-thumbnail" src="" alt="">
                <div>
                    <h1 id="song-title">Loading...</h1>
                    <p class="artist" id="song-artist"></p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-undo btn-small" id="undo-btn" onclick="undo()" disabled title="Undo (Ctrl+Z)">↶ Undo</button>
                <button class="btn btn-undo btn-small" id="redo-btn" onclick="redo()" disabled title="Redo (Ctrl+Y)">↷ Redo</button>
                <div class="status-indicator" id="save-status">All changes saved</div>
                <button class="btn btn-secondary" onclick="window.location.href='/admin.html'">Back to Admin</button>
                <button class="btn btn-success" id="save-btn" onclick="saveChanges()">Save</button>
            </div>
        </div>

        <!-- Top Section: Table + Video -->
        <div class="top-section">
            <!-- Left: Lyrics Table -->
            <div class="lyrics-panel">
                <div class="panel-header">
                    Lyrics <span id="lyrics-count">(0 lines)</span>
                </div>

                <div class="lyrics-table-container">
                    <table class="lyrics-table">
                        <thead>
                            <tr>
                                <th class="col-num">#</th>
                                <th class="col-time">Start</th>
                                <th class="col-time">End</th>
                                <th class="col-dur">Dur</th>
                                <th class="col-text">Text</th>
                            </tr>
                        </thead>
                        <tbody id="lyrics-tbody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Edit Panel -->
                <div class="edit-panel">
                    <div class="edit-panel-title">Edit Selected Line</div>
                    <div class="edit-row">
                        <label>Text:</label>
                        <input type="text" id="edit-text" placeholder="Select a line to edit">
                    </div>
                    <div class="edit-row">
                        <label>Start:</label>
                        <input type="text" id="edit-start" class="time-input" placeholder="0:00.0">
                        <label>Duration:</label>
                        <input type="text" id="edit-duration" class="time-input" placeholder="0.0">
                        <label>End:</label>
                        <input type="text" id="edit-end" class="time-input" placeholder="0:00.0" readonly style="opacity:0.5">
                    </div>
                    <div class="edit-actions">
                        <button class="btn btn-secondary btn-small" onclick="selectPrev()">&lt; Prev</button>
                        <button class="btn btn-secondary btn-small" onclick="selectNext()">Next &gt;</button>
                        <button class="btn btn-secondary btn-small" onclick="splitLine()">Split</button>
                        <button class="btn btn-secondary btn-small" onclick="deleteLine()">Delete</button>
                        <button class="btn btn-secondary btn-small" onclick="insertAfter()">+ Insert</button>
                    </div>
                </div>
            </div>

            <!-- Right: Video -->
            <div class="video-panel">
                <div class="panel-header">
                    Video Preview
                </div>
                <div class="video-wrapper">
                    <div id="youtube-player"></div>
                </div>
                <div class="video-controls">
                    <div class="video-time-display">
                        <span class="current-time-large" id="current-time">0:00.0</span>
                        <span class="duration-small">/ <span id="duration">0:00</span></span>
                    </div>
                    <div class="playback-buttons">
                        <button class="seek-btn" onclick="seekRelative(-5)">-5</button>
                        <button class="seek-btn" onclick="seekRelative(-1)">-1</button>
                        <button class="play-btn" id="play-btn" onclick="togglePlay()">&#9654;</button>
                        <button class="seek-btn" onclick="seekRelative(1)">+1</button>
                        <button class="seek-btn" onclick="seekRelative(5)">+5</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom: Waveform -->
        <div class="waveform-section">
            <div class="waveform-toolbar">
                <div class="waveform-toolbar-left">
                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                    <span class="zoom-label" id="zoom-label">100%</span>
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="btn btn-secondary btn-small" onclick="scrollToPlayhead()">Go to Playhead</button>
                </div>
                <div class="waveform-toolbar-right">
                    <button class="btn btn-secondary btn-small" onclick="playSelection()">&#9654; Play Selection</button>
                    <button class="btn btn-primary btn-small" onclick="setStartToPlayhead()">Set Start</button>
                    <button class="btn btn-primary btn-small" onclick="setEndToPlayhead()">Set End</button>
                    <button class="btn btn-secondary btn-small" onclick="insertAtPlayhead()">+ Insert Here</button>
                </div>
            </div>

            <div class="waveform-container" id="waveform-container">
                <div class="waveform-content" id="waveform-content">
                    <div class="time-ruler" id="time-ruler"></div>
                    <div class="waveform-bars" id="waveform-bars"></div>
                    <div class="subtitle-tracks" id="subtitle-tracks"></div>
                    <div class="playhead" id="playhead"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Hints -->
    <div class="keyboard-hint">
        <kbd>Space</kbd> Play/Pause &nbsp;
        <kbd>&larr;</kbd><kbd>&rarr;</kbd> Seek &nbsp;
        <kbd>&uarr;</kbd><kbd>&darr;</kbd> Navigate &nbsp;
        <kbd>S</kbd> Set Start &nbsp;
        <kbd>E</kbd> Set End &nbsp;
        <kbd>[</kbd><kbd>]</kbd> Nudge timing &nbsp;
        <kbd>Ctrl+C/V</kbd> Copy/Paste
    </div>

    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // ============ STATE ============
        let videoId = null;
        let player = null;
        let lyrics = [];
        let originalLyrics = [];
        let selectedIndex = -1;
        let duration = 0;
        let zoom = 50; // pixels per second
        let isPlaying = false;
        let hasUnsavedChanges = false;
        let adminPassword = '';
        let waveformData = [];
        let waveformSamplesPerSecond = 20;

        // Undo/Redo history
        let undoStack = [];
        let redoStack = [];
        const MAX_HISTORY = 50;

        // Clipboard for copy/paste lines
        let clipboardLine = null;

        // Dragging state
        let isDragging = false;
        let dragType = null; // 'move', 'start', 'end'
        let dragIndex = -1;
        let dragStartX = 0;
        let dragOriginalStart = 0;
        let dragOriginalEnd = 0;

        // ============ INIT ============
        const urlParams = new URLSearchParams(window.location.search);
        videoId = urlParams.get('id');
        adminPassword = localStorage.getItem('admin_password') || '';

        if (!videoId) {
            alert('No video ID provided');
            window.close();
        }

        // YouTube player ready
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                videoId: videoId,
                playerVars: {
                    autoplay: 0,
                    controls: 0,
                    modestbranding: 1,
                    rel: 0
                },
                events: {
                    onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            duration = player.getDuration();
            document.getElementById('duration').textContent = formatTime(duration);
            loadSongData();
            startTimeUpdate();
            setupWaveformClickToSeek();
        }

        function onPlayerStateChange(event) {
            isPlaying = (event.data === YT.PlayerState.PLAYING);
            document.getElementById('play-btn').innerHTML = isPlaying ? '&#10074;&#10074;' : '&#9654;';
        }

        // ============ UNDO/REDO ============
        function saveToHistory() {
            // Save current state to undo stack
            undoStack.push(JSON.stringify(lyrics));
            if (undoStack.length > MAX_HISTORY) {
                undoStack.shift();
            }
            // Clear redo stack when new action is taken
            redoStack = [];
            updateUndoButtons();
        }

        function undo() {
            if (undoStack.length === 0) return;

            // Save current state to redo stack
            redoStack.push(JSON.stringify(lyrics));

            // Restore previous state
            lyrics = JSON.parse(undoStack.pop());

            markUnsaved();
            renderTable();
            renderWaveform();
            updateEditPanel();
            updateUndoButtons();
        }

        function redo() {
            if (redoStack.length === 0) return;

            // Save current state to undo stack
            undoStack.push(JSON.stringify(lyrics));

            // Restore next state
            lyrics = JSON.parse(redoStack.pop());

            markUnsaved();
            renderTable();
            renderWaveform();
            updateEditPanel();
            updateUndoButtons();
        }

        function updateUndoButtons() {
            document.getElementById('undo-btn').disabled = undoStack.length === 0;
            document.getElementById('redo-btn').disabled = redoStack.length === 0;
        }

        // ============ LOAD DATA ============
        async function loadSongData() {
            try {
                const response = await fetch(`/api/songs/${videoId}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                // Update header
                document.getElementById('song-title').textContent = data.song.title;
                document.getElementById('song-artist').textContent = data.song.artist;
                document.getElementById('song-thumbnail').src = data.song.thumbnail_url || '';

                // Load lyrics
                const segments = data.lyrics?.segments || [];
                lyrics = segments.map((seg, i) => ({
                    id: i,
                    text: seg.text || '',
                    start: seg.start || 0,
                    end: seg.end || (seg.start + 3),
                    section: seg.section || 'verse'
                }));

                originalLyrics = JSON.parse(JSON.stringify(lyrics));
                document.getElementById('lyrics-count').textContent = `(${lyrics.length} lines)`;

                // Load real waveform data from API
                await loadWaveformData();

                // Render
                renderTable();
                renderWaveform();

                // Hide loading
                document.getElementById('loading-overlay').style.display = 'none';

            } catch (error) {
                alert('Error loading: ' + error.message);
            }
        }

        async function loadWaveformData() {
            try {
                const response = await fetch(`/api/songs/${videoId}/waveform`);
                const data = await response.json();

                if (data.samples && data.samples.length > 0) {
                    waveformData = data.samples;
                    waveformSamplesPerSecond = data.samples_per_second || 20;
                    console.log(`[WAVEFORM] Loaded ${waveformData.length} samples`);
                } else {
                    // Fallback to simple waveform if API fails
                    console.log('[WAVEFORM] No data from API, using placeholder');
                    generateSimpleWaveform();
                }
            } catch (error) {
                console.log('[WAVEFORM] Error loading, using placeholder:', error);
                generateSimpleWaveform();
            }
        }

        // ============ TIME UPDATE ============
        function startTimeUpdate() {
            setInterval(() => {
                if (player && player.getCurrentTime) {
                    const time = player.getCurrentTime();
                    document.getElementById('current-time').textContent = formatTimeMs(time);
                    updatePlayhead(time);
                    highlightCurrentLine(time);
                }
            }, 50);
        }

        function updatePlayhead(time) {
            const playhead = document.getElementById('playhead');
            playhead.style.left = (time * zoom) + 'px';
        }

        function highlightCurrentLine(time) {
            // Find the line that contains current time
            const currentIdx = lyrics.findIndex(l => time >= l.start && time <= l.end);
            if (currentIdx !== -1 && currentIdx !== selectedIndex) {
                // Auto-select current line while playing (optional)
                // selectLine(currentIdx);
            }
        }

        // ============ FORMAT HELPERS ============
        function formatTime(sec) {
            if (!sec || isNaN(sec)) return '0:00';
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function formatTimeMs(sec) {
            if (!sec || isNaN(sec)) return '0:00.0';
            const m = Math.floor(sec / 60);
            const s = (sec % 60).toFixed(1);
            return `${m}:${s.padStart(4, '0')}`;
        }

        function parseTime(str) {
            const parts = str.split(':');
            if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseFloat(parts[1]);
            }
            return parseFloat(str) || 0;
        }

        // ============ RENDER TABLE ============
        function renderTable() {
            const tbody = document.getElementById('lyrics-tbody');
            tbody.innerHTML = lyrics.map((l, i) => `
                <tr class="${i === selectedIndex ? 'selected' : ''}" onclick="selectLine(${i})" ondblclick="playLine(${i})">
                    <td class="col-num">${i + 1}</td>
                    <td class="col-time">${formatTimeMs(l.start)}</td>
                    <td class="col-time">${formatTimeMs(l.end)}</td>
                    <td class="col-dur">${(l.end - l.start).toFixed(1)}s</td>
                    <td class="col-text" title="${escapeHtml(l.text)}">${escapeHtml(l.text)}</td>
                </tr>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============ RENDER WAVEFORM ============
        function generateSimpleWaveform() {
            // Generate simple random waveform data as fallback
            waveformData = [];
            waveformSamplesPerSecond = 20;
            const samples = Math.ceil(duration * waveformSamplesPerSecond);
            for (let i = 0; i < samples; i++) {
                waveformData.push(Math.random() * 0.5 + 0.3);
            }
        }

        function renderWaveform() {
            const content = document.getElementById('waveform-content');
            const ruler = document.getElementById('time-ruler');
            const bars = document.getElementById('waveform-bars');
            const tracks = document.getElementById('subtitle-tracks');

            // Set width
            const width = duration * zoom;
            content.style.width = Math.max(width, 800) + 'px';

            // Render ruler with more marks for precision
            ruler.innerHTML = '';
            const interval = zoom > 40 ? 5 : (zoom > 20 ? 10 : (zoom > 10 ? 30 : 60));
            for (let t = 0; t <= duration; t += interval) {
                const mark = document.createElement('div');
                mark.className = 'ruler-mark';
                mark.style.left = (t * zoom) + 'px';
                mark.textContent = formatTime(t);
                ruler.appendChild(mark);
            }

            // Render waveform bars from real data
            bars.innerHTML = '';
            if (waveformData.length > 0) {
                const barWidth = zoom / waveformSamplesPerSecond;
                waveformData.forEach((amp, i) => {
                    const bar = document.createElement('div');
                    bar.className = 'waveform-bar';
                    bar.style.position = 'absolute';
                    bar.style.left = (i * barWidth) + 'px';
                    bar.style.width = Math.max(barWidth - 1, 1) + 'px';
                    bar.style.height = Math.max(amp * 55, 2) + 'px';
                    bars.appendChild(bar);
                });
            }

            // Render subtitle blocks
            tracks.innerHTML = '';
            lyrics.forEach((l, i) => {
                const block = document.createElement('div');
                block.className = `subtitle-block ${l.section || ''} ${i === selectedIndex ? 'selected' : ''}`;
                block.style.left = (l.start * zoom) + 'px';
                block.style.width = Math.max((l.end - l.start) * zoom, 20) + 'px';
                block.textContent = l.text.substring(0, 50);
                block.title = l.text;
                block.dataset.index = i;

                // Resize handles
                const leftHandle = document.createElement('div');
                leftHandle.className = 'resize-handle left';
                leftHandle.dataset.handle = 'start';

                const rightHandle = document.createElement('div');
                rightHandle.className = 'resize-handle right';
                rightHandle.dataset.handle = 'end';

                block.appendChild(leftHandle);
                block.appendChild(rightHandle);

                // Events
                block.addEventListener('mousedown', (e) => onBlockMouseDown(e, i));
                block.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!isDragging) selectLine(i);
                });

                tracks.appendChild(block);
            });
        }

        // Click anywhere in waveform area to seek
        function setupWaveformClickToSeek() {
            const container = document.getElementById('waveform-container');
            const content = document.getElementById('waveform-content');

            content.addEventListener('click', (e) => {
                // Only seek if clicking on empty area (not on subtitle blocks)
                if (e.target.closest('.subtitle-block')) return;

                const rect = content.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const time = Math.max(0, Math.min(x / zoom, duration));
                player.seekTo(time, true);
            });
        }

        // ============ BLOCK DRAGGING ============
        function onBlockMouseDown(e, index) {
            e.preventDefault();
            const handle = e.target.dataset?.handle;

            // Save state for undo before dragging
            saveToHistory();

            isDragging = true;
            dragIndex = index;
            dragType = handle || 'move';
            dragStartX = e.clientX;
            dragOriginalStart = lyrics[index].start;
            dragOriginalEnd = lyrics[index].end;

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        function onMouseMove(e) {
            if (!isDragging) return;

            const deltaX = e.clientX - dragStartX;
            const deltaTime = deltaX / zoom;
            const l = lyrics[dragIndex];

            if (dragType === 'start') {
                l.start = Math.max(0, Math.min(dragOriginalStart + deltaTime, l.end - 0.5));
            } else if (dragType === 'end') {
                l.end = Math.max(l.start + 0.5, dragOriginalEnd + deltaTime);
            } else {
                const newStart = Math.max(0, dragOriginalStart + deltaTime);
                const dur = dragOriginalEnd - dragOriginalStart;
                l.start = newStart;
                l.end = newStart + dur;
            }

            markUnsaved();
            renderTable();
            renderWaveform();
            updateEditPanel();
        }

        function onMouseUp() {
            isDragging = false;
            dragType = null;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        // ============ SELECTION ============
        function selectLine(index) {
            selectedIndex = index;
            renderTable();
            renderWaveform();
            updateEditPanel();

            // Scroll table row into view
            const row = document.querySelector(`#lyrics-tbody tr:nth-child(${index + 1})`);
            if (row) row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // Scroll waveform to show block
            const container = document.getElementById('waveform-container');
            const blockLeft = lyrics[index].start * zoom;
            const blockRight = lyrics[index].end * zoom;
            const viewLeft = container.scrollLeft;
            const viewRight = viewLeft + container.clientWidth;

            if (blockLeft < viewLeft || blockRight > viewRight) {
                container.scrollLeft = blockLeft - 100;
            }
        }

        function selectPrev() {
            if (selectedIndex > 0) selectLine(selectedIndex - 1);
        }

        function selectNext() {
            if (selectedIndex < lyrics.length - 1) selectLine(selectedIndex + 1);
        }

        function updateEditPanel() {
            const textInput = document.getElementById('edit-text');
            const startInput = document.getElementById('edit-start');
            const durInput = document.getElementById('edit-duration');
            const endInput = document.getElementById('edit-end');

            if (selectedIndex >= 0 && selectedIndex < lyrics.length) {
                const l = lyrics[selectedIndex];
                textInput.value = l.text;
                startInput.value = formatTimeMs(l.start);
                durInput.value = (l.end - l.start).toFixed(1);
                endInput.value = formatTimeMs(l.end);
                textInput.disabled = false;
                startInput.disabled = false;
                durInput.disabled = false;
            } else {
                textInput.value = '';
                startInput.value = '';
                durInput.value = '';
                endInput.value = '';
                textInput.disabled = true;
                startInput.disabled = true;
                durInput.disabled = true;
            }
        }

        // Edit panel input handlers
        document.getElementById('edit-text').addEventListener('input', (e) => {
            if (selectedIndex >= 0) {
                lyrics[selectedIndex].text = e.target.value;
                markUnsaved();
                renderTable();
                renderWaveform();
            }
        });

        document.getElementById('edit-start').addEventListener('change', (e) => {
            if (selectedIndex >= 0) {
                const newStart = parseTime(e.target.value);
                const l = lyrics[selectedIndex];
                const dur = l.end - l.start;
                l.start = newStart;
                l.end = newStart + dur;
                markUnsaved();
                renderTable();
                renderWaveform();
                updateEditPanel();
            }
        });

        document.getElementById('edit-duration').addEventListener('change', (e) => {
            if (selectedIndex >= 0) {
                const dur = parseFloat(e.target.value) || 1;
                lyrics[selectedIndex].end = lyrics[selectedIndex].start + dur;
                markUnsaved();
                renderTable();
                renderWaveform();
                updateEditPanel();
            }
        });

        // ============ PLAYBACK ============
        function togglePlay() {
            if (isPlaying) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function seekRelative(sec) {
            const time = player.getCurrentTime();
            player.seekTo(Math.max(0, time + sec), true);
        }

        function playLine(index) {
            const l = lyrics[index];
            selectLine(index);
            player.seekTo(l.start, true);
            player.playVideo();

            // Stop at end
            const checkEnd = setInterval(() => {
                if (player.getCurrentTime() >= l.end) {
                    player.pauseVideo();
                    clearInterval(checkEnd);
                }
            }, 100);
        }

        function playSelection() {
            if (selectedIndex >= 0) {
                playLine(selectedIndex);
            }
        }

        // ============ TIMESTAMP ACTIONS ============
        function setStartToPlayhead() {
            if (selectedIndex < 0) {
                alert('Select a line first');
                return;
            }

            saveToHistory();

            const time = player.getCurrentTime();
            const l = lyrics[selectedIndex];

            // Just set start time, end stays the same (duration changes)
            // But don't let start go past end
            if (time < l.end) {
                l.start = time;
            } else {
                // If playhead is past end, set start just before end
                l.start = l.end - 0.5;
            }

            markUnsaved();
            renderTable();
            renderWaveform();
            updateEditPanel();

            // Visual feedback - briefly highlight
            flashBlock(selectedIndex);
        }

        function setEndToPlayhead() {
            if (selectedIndex < 0) {
                alert('Select a line first');
                return;
            }

            saveToHistory();

            const time = player.getCurrentTime();
            const l = lyrics[selectedIndex];

            // Just set end time, start stays the same (duration changes)
            // But don't let end go before start
            if (time > l.start) {
                l.end = time;
            } else {
                // If playhead is before start, set end just after start
                l.end = l.start + 0.5;
            }

            markUnsaved();
            renderTable();
            renderWaveform();
            updateEditPanel();

            // Visual feedback
            flashBlock(selectedIndex);
        }

        function flashBlock(index) {
            // Brief visual feedback when a block is modified
            const block = document.querySelector(`.subtitle-block[data-index="${index}"]`);
            if (block) {
                block.style.transition = 'none';
                block.style.boxShadow = '0 0 15px var(--accent)';
                setTimeout(() => {
                    block.style.transition = 'box-shadow 0.5s';
                    block.style.boxShadow = 'none';
                }, 100);
            }
        }

        function insertAtPlayhead() {
            saveToHistory();

            const time = player.getCurrentTime();
            const newLine = {
                id: Date.now(),
                text: 'New line',
                start: time,
                end: time + 3,
                section: 'verse'
            };

            // Find insert position
            let idx = lyrics.findIndex(l => l.start > time);
            if (idx === -1) idx = lyrics.length;

            lyrics.splice(idx, 0, newLine);
            markUnsaved();
            renderTable();
            renderWaveform();
            selectLine(idx);
        }

        function insertAfter() {
            if (selectedIndex < 0) return;

            saveToHistory();

            const prev = lyrics[selectedIndex];
            const newLine = {
                id: Date.now(),
                text: 'New line',
                start: prev.end,
                end: prev.end + 3,
                section: prev.section
            };
            lyrics.splice(selectedIndex + 1, 0, newLine);
            markUnsaved();
            renderTable();
            renderWaveform();
            selectLine(selectedIndex + 1);
        }

        function splitLine() {
            if (selectedIndex < 0) return;

            saveToHistory();

            const l = lyrics[selectedIndex];
            const mid = (l.start + l.end) / 2;
            const words = l.text.split(' ');
            const midWord = Math.ceil(words.length / 2);

            const line1 = {
                id: Date.now(),
                text: words.slice(0, midWord).join(' '),
                start: l.start,
                end: mid,
                section: l.section
            };
            const line2 = {
                id: Date.now() + 1,
                text: words.slice(midWord).join(' '),
                start: mid,
                end: l.end,
                section: l.section
            };

            lyrics.splice(selectedIndex, 1, line1, line2);
            markUnsaved();
            renderTable();
            renderWaveform();
        }

        function deleteLine() {
            if (selectedIndex < 0) return;
            if (!confirm('Delete this line?')) return;

            saveToHistory();

            lyrics.splice(selectedIndex, 1);
            if (selectedIndex >= lyrics.length) selectedIndex = lyrics.length - 1;
            markUnsaved();
            renderTable();
            renderWaveform();
            updateEditPanel();
        }

        // ============ COPY/PASTE LINES ============
        function copyLine() {
            if (selectedIndex < 0) return;
            clipboardLine = JSON.parse(JSON.stringify(lyrics[selectedIndex]));
            console.log('Copied line:', clipboardLine.text);
        }

        function pasteLine() {
            if (!clipboardLine) {
                alert('Nothing to paste. Select a line and press Ctrl+C first.');
                return;
            }

            saveToHistory();

            const newLine = {
                ...JSON.parse(JSON.stringify(clipboardLine)),
                id: Date.now()
            };

            // Insert after selected line, or at end if nothing selected
            const insertIdx = selectedIndex >= 0 ? selectedIndex + 1 : lyrics.length;
            lyrics.splice(insertIdx, 0, newLine);

            markUnsaved();
            renderTable();
            renderWaveform();
            selectLine(insertIdx);
        }

        // ============ NUDGE TIMING ============
        function nudgeStart(delta) {
            if (selectedIndex < 0) return;

            saveToHistory();

            const l = lyrics[selectedIndex];
            const newStart = Math.max(0, l.start + delta);
            // Don't let start go past end - 0.1s
            if (newStart < l.end - 0.1) {
                l.start = newStart;
            }

            markUnsaved();
            renderTable();
            renderWaveform();
            updateEditPanel();
        }

        function nudgeEnd(delta) {
            if (selectedIndex < 0) return;

            saveToHistory();

            const l = lyrics[selectedIndex];
            const newEnd = l.end + delta;
            // Don't let end go before start + 0.1s
            if (newEnd > l.start + 0.1) {
                l.end = newEnd;
            }

            markUnsaved();
            renderTable();
            renderWaveform();
            updateEditPanel();
        }

        // ============ ZOOM ============
        function zoomIn() {
            zoom = Math.min(zoom * 1.5, 200);
            document.getElementById('zoom-label').textContent = Math.round(zoom * 2) + '%';
            renderWaveform();
        }

        function zoomOut() {
            zoom = Math.max(zoom / 1.5, 10);
            document.getElementById('zoom-label').textContent = Math.round(zoom * 2) + '%';
            renderWaveform();
        }

        function scrollToPlayhead() {
            const container = document.getElementById('waveform-container');
            const time = player.getCurrentTime();
            container.scrollLeft = time * zoom - container.clientWidth / 2;
        }

        // ============ SAVE ============
        function markUnsaved() {
            hasUnsavedChanges = true;
            document.getElementById('save-status').textContent = 'Unsaved changes';
            document.getElementById('save-status').style.background = 'rgba(255,45,120,0.2)';
            document.getElementById('save-status').style.borderColor = 'var(--primary)';
            document.getElementById('save-status').style.color = 'var(--primary)';
        }

        async function saveChanges() {
            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const segments = lyrics.map(l => ({
                    text: l.text,
                    start: l.start,
                    end: l.end,
                    section: l.section
                }));

                const response = await fetch(`/api/admin/song/${videoId}/timestamps`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({ segments })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                hasUnsavedChanges = false;
                originalLyrics = JSON.parse(JSON.stringify(lyrics));

                document.getElementById('save-status').textContent = 'All changes saved';
                document.getElementById('save-status').style.background = 'rgba(0,245,160,0.2)';
                document.getElementById('save-status').style.borderColor = 'var(--green)';
                document.getElementById('save-status').style.color = 'var(--green)';

            } catch (error) {
                alert('Error saving: ' + error.message);
            }

            btn.disabled = false;
            btn.textContent = 'Save';
        }

        // ============ KEYBOARD SHORTCUTS ============
        document.addEventListener('keydown', (e) => {
            // Don't capture if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.key === 'Escape') {
                    e.target.blur();
                }
                return;
            }

            // Ctrl/Cmd shortcuts
            if (e.ctrlKey || e.metaKey) {
                if (e.code === 'KeyZ') {
                    e.preventDefault();
                    if (e.shiftKey) {
                        redo();
                    } else {
                        undo();
                    }
                    return;
                }
                if (e.code === 'KeyY') {
                    e.preventDefault();
                    redo();
                    return;
                }
                if (e.code === 'KeyS') {
                    e.preventDefault();
                    saveChanges();
                    return;
                }
                if (e.code === 'KeyC') {
                    e.preventDefault();
                    copyLine();
                    return;
                }
                if (e.code === 'KeyV') {
                    e.preventDefault();
                    pasteLine();
                    return;
                }
            }

            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    togglePlay();
                    break;

                case 'ArrowLeft':
                    e.preventDefault();
                    seekRelative(e.shiftKey ? -0.1 : -1);
                    break;

                case 'ArrowRight':
                    e.preventDefault();
                    seekRelative(e.shiftKey ? 0.1 : 1);
                    break;

                case 'ArrowUp':
                    e.preventDefault();
                    selectPrev();
                    break;

                case 'ArrowDown':
                    e.preventDefault();
                    selectNext();
                    break;

                case 'KeyS':
                    e.preventDefault();
                    setStartToPlayhead();
                    break;

                case 'KeyE':
                    e.preventDefault();
                    setEndToPlayhead();
                    break;

                case 'KeyI':
                    e.preventDefault();
                    insertAtPlayhead();
                    break;

                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0) playLine(selectedIndex);
                    break;

                case 'Delete':
                case 'Backspace':
                    e.preventDefault();
                    deleteLine();
                    break;

                case 'BracketLeft': // [
                    e.preventDefault();
                    if (e.shiftKey) {
                        nudgeStart(0.1);  // Shrink: move start later
                    } else {
                        nudgeStart(-0.1); // Expand: move start earlier
                    }
                    break;

                case 'BracketRight': // ]
                    e.preventDefault();
                    if (e.shiftKey) {
                        nudgeEnd(-0.1);  // Shrink: move end earlier
                    } else {
                        nudgeEnd(0.1);   // Expand: move end later
                    }
                    break;
            }
        });

        // Warn on close with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
